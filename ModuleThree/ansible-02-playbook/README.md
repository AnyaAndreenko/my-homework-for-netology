# Домашнее задание к занятию 2 «Работа с Playbook»

1. Подготовьте свой inventory-файл prod.yml.

   [prod.yml](https://github.com/AnyaAndreenko/mnt-homeworks/blob/MNT-video/08-ansible-02-playbook/playbook/inventory/prod.yml)
   
3. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает vector. Конфигурация vector должна деплоиться через template файл jinja2. От вас не требуется использовать все возможности шаблонизатора, просто вставьте стандартный конфиг в template файл. Информация по шаблонам по ссылке. не забудьте сделать handler на перезапуск vector в случае изменения конфигурации!

   [site.yml](https://github.com/AnyaAndreenko/mnt-homeworks/blob/MNT-video/08-ansible-02-playbook/playbook/site.yml)


4. При создании tasks рекомендую использовать модули: get_url, template, unarchive, file.
Tasks должны: скачать дистрибутив нужной версии, выполнить распаковку в выбранную директорию, установить vector.

   [site.yml](https://github.com/AnyaAndreenko/mnt-homeworks/blob/MNT-video/08-ansible-02-playbook/playbook/site.yml)

5. Запустите ansible-lint site.yml и исправьте ошибки, если они есть.
6. Попробуйте запустить playbook на этом окружении с флагом --check.

   
  ``` ann@andreenkoa:~/mnt-homeworks/08-ansible-02-playbook/playbook$ ansible-playbook -i inventory/prod.yml site.yml--check```
```
PLAY [Install Clickhouse] **********************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************************************************************************

ED25519 key fingerprint is SHA256: *****.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
ok: [clickhouse]

TASK [Get clickhouse distrib] ******************************************************************************************************************************************************************************************************************************************
changed: [clickhouse] => (item=clickhouse-client)
changed: [clickhouse] => (item=clickhouse-server)

TASK [Install clickhouse packages] *************************************************************************************************************************************************************************************************************************************

fatal: [localhost]: FAILED! => {"changed": false, "msg": "Failed to update apt cache: W:GPG error: https://packages.clickhouse.com/deb stable InRelease: The following signatures couldn't be verified because the public key is not available: 
NO_PUBKEY 3E4AD4719DDE9A38, E:The repository 'https://packages.clickhouse.com/deb stable InRelease' is not signed."}    



PLAY RECAP ******************************************************************************************************************************************************************************************************************************
clickhouse-01              : ok=2    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0  
  ``` 
   
   
7. Запустите playbook на prod.yml окружении с флагом --diff. Убедитесь, что изменения на системе произведены.
8. Повторно запустите playbook с флагом --diff и убедитесь, что playbook идемпотентен.

   
     ```ann@andreenkoa:~/mnt-homeworks/08-ansible-02-playbook/playbook$ ~/netology/homework/mnt-homeworks/08-ansible-02-playbook/playbook$ ansible-playbook  -i inventory/prod.yml site.yml --diff  ```


  ```PLAY [Install Clickhouse] **********************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************************************************************************
ok: [clickhouse]

TASK [Get clickhouse distrib] ******************************************************************************************************************************************************************************************************************************************
failed: [clickhouse] (item=clickhouse-client) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-client-23.8.4.69.rpm", "elapsed": 4, "gid": 0, "group": "root", "item": "clickhouse-client", "mode": "0644", "msg": "Request failed: <urlopen error [Errno -2] Name or service not known>", "owner": "root", "size": 97323, "state": "file", "uid": 0, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-client-23.8.4.69.x86_64.rpm"}
failed: [clickhouse] (item=clickhouse-server) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-server-23.8.4.69.rpm", "elapsed": 0, "gid": 0, "group": "root", "item": "clickhouse-server", "mode": "0644", "msg": "Request failed: <urlopen error [Errno -2] Name or service not known>", "owner": "root", "size": 125915, "state": "file", "uid": 0, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-server-23.8.4.69.x86_64.rpm"}


TASK [Get clickhouse distrib (rescue)] *********************************************************************************************************************************************************************************************************************************
ok: [clickhouse]

TASK [Install clickhouse packages] *************************************************************************************************************************************************************************************************************************************
ok: [clickhouse]

TASK [Flush handlers to restart clickhouse] ****************************************************************************************************************************************************************************************************************************

PLAY [Install vector] **************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************************************************************************
ok: [vector]

TASK [Get vector distrib] **********************************************************************************************************************************************************************************************************************************************
ok: [vector]

TASK [Install vector packages] *****************************************************************************************************************************************************************************************************************************************
ok: [vector]

TASK [Flush handlers to restart vector] ********************************************************************************************************************************************************************************************************************************

TASK [Configure Vector | ensure what directory exists] *****************************************************************************************************************************************************************************************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/root/vector_config",
-    "state": "absent"
+    "state": "directory"
 }

changed: [vector]

TASK [Configure Vector | Template config] ******************************************************************************************************************************************************************************************************************************
--- before
+++ after: /root/.ansible/tmp/ansible-local-1852938w20gcz8t/tmp2sf1rpdm/vector.yml.j2
@@ -0,0 +1,45 @@
+# Простая конфигурация Vector
  
  ```TASK [Install clickhouse packages] *************************************************************************************************************************************************************************************************************************************
ok: [clickhouse]

TASK [Flush handlers to restart clickhouse] ****************************************************************************************************************************************************************************************************************************

PLAY [Install vector] **************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************************************************************************
ok: [vector]

TASK [Get vector distrib] **********************************************************************************************************************************************************************************************************************************************
ok: [vector]

TASK [Install vector packages] *****************************************************************************************************************************************************************************************************************************************
ok: [vector]

TASK [Flush handlers to restart vector] ********************************************************************************************************************************************************************************************************************************

TASK [Configure Vector | ensure what directory exists] *****************************************************************************************************************************************************************************************************************
ok: [vector]

TASK [Configure Vector | Template config] ******************************************************************************************************************************************************************************************************************************
ok: [vector]

PLAY RECAP *************************************************************************************************************************************************************************************************************************************************************
clickhouse              : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
vector                  : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```
9. Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги. Пример качественной документации ansible playbook по ссылке. Так же приложите скриншоты выполнения заданий №5-8
10. Готовый playbook выложите в свой репозиторий, поставьте тег 08-ansible-02-playbook на фиксирующий коммит, в ответ предоставьте ссылку на него.

11. мой https://github.com/AnyaAndreenko/mnt-homeworks/tree/MNT-video/08-ansible-02-playbook/playbook 
